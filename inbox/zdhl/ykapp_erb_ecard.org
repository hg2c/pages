* 愉快网电子预订簿 - ecard 电子会员卡数据表

1. 本表设计混乱，向大家诚挚致歉；
2. 所以建议尽早重构代码以使用改进后的表结构；
2. ecard_member 表已在第一次重构后弃用，分拆成了3个表：member, member_card, member_behavior；

**  ecard_ecard (电子会员卡定义表)

| 字段          | 说明                                                                                          |
|---------------+-----------------------------------------------------------------------------------------------|
| guid          | 会员卡种类，GUID类型。如：0454da65-4304-4732-b654-ad46f0e37a83                                |
| issuer        | 会员卡发行者代码。编码规则——商家：M-{yukuai.merchant.code}；品牌：B-{yukuai_3g.brand_info.id} |
| name          | 卡片名称。如：钻石会员                                                                        |
| level         | 卡片等级，由商家自定义。数字越大，表示卡片级别越高。                                          |
| description   | 卡面文字说明。如：本卡有效期到2015年1月；生日到店消费5折；所有门店均可使用。                  |
| issue_rule    | 发行规则。                                                                                    |
| discount_rule | 优惠规则。                                                                                    |
| expire_rule   | 有效期规则。                                                                                  |
| publish_count | 商家已发行该卡种数量。                                                                        |
| requirement   | 发行规则文字说明                                                                              |
| auto_exchange | 用户达成本卡种发行条件时，是否自动发卡。                                                      |
| status        | 启用状态。取值范围——0：停用 1：启用                                                           |
| creator       | 创建人                                                                                        |
| created       | 创建时间                                                                                      |
| modifier      | 修改人                                                                                        |
| modified      | 修改时间                                                                                      |

1. 由发行者借助愉快网平台自主发行的会员卡。
2. 原有的会员级别概念，如 钻石1，钻石2。在新表中体现为两个会员卡类别；
3. 优惠规则，发行条件可先只支持最简单的情况，留待将来扩展；
4. 优惠规则最简单情况：0.8，表示8折；
5. 发行条件暂可为空，使用手动发卡。


** ecard_card_config (电子会员卡配置表)

| 字段        | 说明                 |
|-------------+----------------------|
| id          | 自增ID               |
| issuer      |                      |
| ecard_guid  | 默认发行的会员卡卡种 |
| description | 温馨提示             |
| if_vaild    | 1 有效 0无效         |
| creator     |                      |
| created     |                      |
| modifier    |                      |
| modified    |                      |


** ecard_card_log (电子会员卡操作记录表)

| 字段      | 说明                          |
|-----------+-------------------------------|
| member_id | 会员ID                        |
| old_guid  | 原卡卡种                      |
| new_guid  | 现卡卡种                      |
| operator  | 操作人                        |
| created   |                               |
| type      | 操作类型：1开卡、2销卡、3升级 |
| remark    | 备注                          |

1. 该表用于记录卡片发行，卡片升级，卡片销毁等相关日志
2. 开卡时设置原卡卡种为空
3. 销卡时设置现卡卡种为空


**  ！已弃用！ecard_member (自有会员基础信息表)

| 字段             | 说明                   | 示例              |
|------------------+------------------------+-------------------|
| id               | 自增会员ID             |                   |
| card_issuer      | 会员卡发行者代码。同上 |                   |
| card_number      | 卡面印刷的会员卡编号   | CSC-VIP-0000001   |
| card_guid        | 卡种                   |                   |
| userpin          | 愉快网用户userpin      |                   |
|                  |                        |                   |
|------------------+------------------------+-------------------|
| realname         | 姓名                   | 飞由              |
| mobile           |                        |                   |
| sex              | 性别                   |                   |
| birthday         | 生日                   |                   |
| job              | 身份                   | 宝洁公司-市场经理 |
| password         | 密码                   | 123456            |
| point            | 代金币                 | 999               |
| dining_table     | 常定餐位               | 牡丹；月季        |
| dining_count     | 就餐次数               |                   |
| customer_manager | 客户经理ID             |                   |
| taste            | 口味                   | 清淡              |
| favorite_dishes  | 菜品喜好               | 清蒸鱼,清蒸鱼     |
| remark           | 备注                   | 备注信息          |
|                  |                        |                   |
|------------------+------------------------+-------------------|
| expire_time      | 过期时间               |                   |
| created          |                        |                   |

1. 废弃线上数据库中 card_type 字段，并保持 card_issuer 编码规则同上一致；
2. 这里设计的 customer_manager 客户经理不能满足，会员对同一品牌不同店面，不同经理的需求；
3. 根据用户联系电话，匹配愉快网userpin；
4. 愉快网用户数据库匹配不到该联系电话时，自动创建愉快网userpin；
5. 发行者独享所有会员的信息；
6. 会员的姓名，联系电话、性别、密码由商家自主收集；
7. 愉快网用户和商家、品牌用户表中的所有用户信息各自独立，如用户可能在愉快网叫小王，但在商家1叫王大，在品牌2叫王二；
8. 代金币可以理解成会员积分；
9. 密码可理解为验证码，明文存储
10. 常定餐位、就餐次数数据可以从订单信息表中查到；
11. 如以后发行实体卡，实体卡的芯片ID，需增加一个字段保存。


** ecard_member_point_log (自有会员代金币操作记录表)

| 字段      | 说明                      |                      示例 |
|-----------+---------------------------+---------------------------|
| member_id | * 会员ID                  |                        32 |
| type      | 操作方式。1:抵扣          |                         1 |
| flow      | 资金流向：IN收入，OUT支出 |                        IN |
| point     | 操作值                    |                       100 |
| balance   | 账户余额                  |                       900 |
| remark    | 备注                      | 代金币抵扣买单，用去100分 |
| operator  | 操作人                    |                 ykapp_yxt |
| created   | 操作时间                  |                           |

- 用户代金币的增减记录日志
- 操作人为任意字符串，和userpin等无关联


** ecard_point_award_rule (积分奖励规则定义)

| 字段       | 说明                               | 示例                    |
|------------+------------------------------------+-------------------------|
| rule_id    | 自增ID                             |                         |
| ecard_guid | 卡种                               |                         |
| actived    | 规则启用状态。0: 停用 1：启用      |                         |
| pattern    | 规则模式。详见附注种的积分奖励规则 | get_X_point_per_invited |
| parameters | 规则参数                           | {X:100}                 |
| creator    |                                    |                         |
| modifier   |                                    |                         |
| created    |                                    |                         |
| modified   |                                    |                         |

** ecard_ref_merchant (电子会员卡支持的商家)

| 字段        | 说明 |
|-------------+------|
| id          |      |
| ecard_guid  |      |
| merchant_id |      |
| creator     |      |
| created     |      |

** member (会员基本信息表)

| 字段          | 说明                     |
|---------------+--------------------------|
| mid           | 自增会员ID               |
| uid           | 愉快网userpin            |
| business_id   | 发行者代码，编码规则同上 |
| mobile        |                          |
| source        | 来源。10：商家导入       |
| weixin        | 微信账号                 |
| sina_weibo    | 新浪微博                 |
| city_code     | 城市代码                 |
| sn            | 序号                     |
| name          |                          |
| sex           |                          |
| birthday      |                          |
| job           |                          |
| security_code | 验证码                   |
| point         | 代金币                   |
| manager       | 客户经理                 |
| comment       |                          |
| created       |                          |

1. sn 序号表示，这是第几位加入的会员。

** member_behavior (会员行为统计)

| 字段            | 说明         |
|-----------------+--------------|
| bid             | 自增ID       |
| mid             | 会员ID       |
| uid             | userpin      |
| business_id     | 发行者ID     |
| recommend_count | 推荐好友数   |
| cost_times      | 累计消费次数 |
| cost_total      | 累计消费金额 |
| taste           | 口味         |
| favorite_dish   | 菜品喜好     |
| favorite_table  | 常定桌台     |

1. 推荐使用 uid 和 business_id 查询。

** member_card (会员现有的会员卡)

| 字段        | 说明           |
|-------------+----------------|
| cid         | 自增id         |
| mid         | 会员ID         |
| uid         | userpin        |
| business_id | 发行者代码     |
| type_id     | 卡种           |
| sn          | 序号           |
| number      | 卡面印刷的编号 |
| expire      | 卡片过期时间   |
| comment     | 备注           |

1. sn 序号表示，这是发行的第几张会员卡。

* 附注

** 发行规则

*** 定义
使用约定好的自定义字符串表达发行规则。规则可设置变量，也可调用存储于其它表的数据（如邀请好友数）。

+ 发行规则若包含变量，用 '规则(变量) ' 表示，如 'b(2)'
+ 一张卡可以有多条发行规则，多条规则之间用分号分隔，比如 'a;b(2);c'
+ 发行规则 a, b, c 之间是 OR 关系，即 a || b(2) || c
+ 示例：total_cost_X_and_invite_Y({X:2,Y:8});once_cost({X:300});total_cost(1000)
+ 添加规则时，在规则定义里约定一个字符串和参数即可
+ 约定规则为小写字母和下划线组成，约定规则中的变量用大写字母

*** 使用
取出规则字符串后，由程序解析。可根据具体情况优化解析逻辑。

*** 已约定的发行规则表

| 规则定义                  | 变量      | 规则说明                                         |
|---------------------------+-----------+--------------------------------------------------|
| any                       | 无        | 无需条件                                         |
| total_cost                | 1000      | 累计消费额达 1000 元                             |
| once_cost_X               | {X:300}   | 单次消费额达 X=300 元                            |
| total_cost_X_and_invite_Y | {X:2,Y:8} | 累计消费次数达 X=2 次，且成功邀请好友数达 Y=8 次 |
| had_starlight_card        | 无        | 曾经拥有过星光卡                                 |

** 有效期规则

*** 已约定的有效期规则表

| 规则定义   | 规则说明                |
|------------+-------------------------|
| never / 0  | 永不过期                |
| +1year     | 至发行之日起一年后过期  |
| +6month    | 至发行之日起6个月后过期 |
| 1383812965 | 过期时间戳              |

** 积分奖励规则
+ 使用该规则的表，需建立 规则模式 和 变量值 两个字段

+ 规则模式 rule
  - 定义：是一个用来标识一类规则的字符串。
  - 可变量：可选则在规则模式中，使用大写字母表示需在管理界面配置的变量。

  - 积分操作规则列表:
     | 模式                    | 说明                       |
     |-------------------------+----------------------------|
     | use                     | 正常使用                   |
     | get_X_point_per_invited | 每成功邀请 1 人奖励 X 积分 |
     | promotion               | 营销活动赠送               |
     | get_X_point_per_cost_Y  | 单次消费满 Y 元得 X 积分   |


+ 变量值 value
  本字段用来保存 规则模式 中的 可变量值，可以直接保存数字。当可变量不只一个时，使用 JSON 字符串保存。
  示例：
  | pattern                 | parameters     | comment                     |
  |-------------------------+----------------+-----------------------------|
  | get_X_point_per_invited | 11             | 每成功邀请 1 人奖励 11 积分 |
  | promotion               | 100            | 赠送 100 积分               |
  | get_X_point_per_cost_Y  | {X:100,Y:10}   | 单次消费满 100 元得 10 积分 |
  | get_X_point_per_cost_Y  | {X:1000,Y:200} | 单次消费满 100 元得 10 积分 |
