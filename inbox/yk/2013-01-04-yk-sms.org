---
deploy: yk
layout: post
title: "愉快网短信接口文档 V1.0"
date: 2013-01-04 16:31
comments: true
categories: yk sms
---
#+OPTIONS: ^:nil

* 术语定义

  | 术语     | 定义                                                                 |
  |----------+----------------------------------------------------------------------|
  | SVN库    | svn://svn.yukuai.cn/yk-sms                                           |
  | 短信接口 | 即外部商业短信网关，如漫道。本系统使用多个短信接口执行收发短信任务。 |
  | 系统     | 即短信服务器。调用外部短信接口，为愉快网提供短信发送服务。           |
  | 来源     | 为调用系统收发短信的应用，系统为每个应用提供一个标识，以区别来源。   |

* 系统安全

** 日志记录

1. 以文件形式，记录每一条短信发送情况
2. 每天一个记录文件

*** 日志级别定义
    | 级别    | 定义                 | 动作     |
    |---------+----------------------+----------|
    | ERROR   | 系统确定被非法调用   | 短信报警 |
    | WARNING | 系统很可能被非法调用 | 短信报警 |
    | NOTICE  | 系统发觉到可能的异常 | 暂无     |
    | INFO    | 一般记录             | 暂无     |

*** 日志内容
    | 时间 | IP | 发送是否成功 | 来源 | 手机号 | 短信内容 | 发送结果 |

** 来源监控

*** 验证、识别来源
1. 建立 OAuth 验证服务器；
2. 通过 OAuth 协议验证、识别来源身份；
3. 该验证服务器可放置在内网，这样外网就无法通过验证。

*** 来源权限
1. 设定可发送短信的来源范围，如（外卖、约会）；
2. 进阶：设定来源的可发送短信时段。

*** 监控日志
    | 级别    | 条件               |
    |---------+--------------------|
    | WARNING | 来源无权限进入系统 |

** 短信内容监控

*** 敏感词过滤
    建立敏感词词库，驳回含敏感词的短信

*** 危险正则表达式匹配
    作为敏感词过滤的补充，对系统短信不可能包含的文本模式，建立危险正则
    表达式，驳回匹配成功的短信。

    | 规则     | 说明                           | 正则表达式 |
    |----------+--------------------------------+------------|
    | 电子邮件 | 短信内不可能含电子邮件         |            |
    | 电话号码 | 短信内不可能含400/1001号段     |            |
    | 网址     | 短信内不可能含愉快网以外的网址 |            |

*** 白名单匹配
    当（使用正则表达式）检测到短信内容出现特定文本模式时，如该文本匹配
    白名单失败，则驳回。

    | 规则     | 说明                 | 正则表达式 |
    |----------+----------------------+------------|
    | 电话号码 | 只能为 968002 968003 |            |

*** 监控日志
    | 级别    | 条件                   |
    |---------+------------------------|
    | NOTICE  | 短信内容内含敏感词     |
    | WARNING | 短信内 URL容内含敏感词 |
    | ERROR   | 正则表达式匹配短信成功 |
    | ERROR   | 白名单匹配短信失败     |


** TODO 短信发送数量监控

*** 历史数据分析算法

1. 定义：每小时为一个时段；
2. 设时间 T：2012年12月12日，第 50 周，20:19，第20个时段，星期三；
3. 设该时段已发送短信总量为 X；
4. 记录以下时间的短信发送总量：
   | 时间                | 1              | 2              | 3              |
   |---------------------+----------------+----------------+----------------|
   | 过去 3 个时段       | 19             | 18             | 17             |
   | 过去 3 天的同一时段 | 11日20时       | 10日20时       | 9日20时        |
   | 过去 3 周的同一天   | 49周周三       | 48周周三       | 47周周三       |
   |---------------------+----------------+----------------+----------------|
   | 过去 3 月的同一天   | 11月12日       | 10月12日       | 9月12日        |
   | 过去 3 年的同一天   | 2011年12月12日 | 2010年12月12日 | 2009年12月12日 |

5. 在此我们暂记录前 3 行，共 9 个历史数据，求得其平均值为 A：

*** 监控日志
   | 级别    | 条件    |
   |---------+---------|
   | NOTICE  | X > 2A  |
   | WARNING | X > 10A |


* 更进一步

下面几条因时间紧张暂不开发，当上诉方式还无法应对时考虑启用下列策略。

** 完善短信发送数量监控
1. 历史数据可标记其是否安全，如数据已被污染，可以人工矫正。
2. 还可以通过统计学建立数学模型验证，以得到更精确的分析结果。
3. 可对总量，每分钟、每小时、每天都有配额

** 群发短信监控
   怎么定义群发？

** 限定短信内容模板
   作为对短信内容的进一步控制，限定来源仅能使用系统内定的模板发送短信。

*** 模板示例
1. ［关涛］已审核通过您的报名，邀请您参加［2012-11-10 18:00］在［外婆桥（大都会店）］的聚餐活动。详询：968002
2. 您的朋友 ［关涛］已发起［2012-11-10 18:00］在［外婆桥（大都会店）］聚餐，邀请您参加，报名请回复 1 。详询：968002
3. 报名成功，请登录www.yukuai.com，随时了解活动情况。详询：968002
4. 报名成功！您可以通过本手机号作为帐号与密码，登录www.yukuai.com，随时了解活动情况。详询：968002

*** 模板变量
1. 模板中包含变量，以供来源调用时替换变量已生成想要的短信。
   如: ［审核人］已审核通过您的报名，邀请您参加［详细时间］在［餐厅名
   字］的聚餐活动。详询：[客服电话]
2. 定义每个变量的类型，最大长度，可选值范围并加以验证。

*** 模板相关数据表

**** sms_template | 短信模板表
     | 名字     | 类型         | 注释     | 说明            |
     |----------+--------------+----------+-----------------|
     | id       | char(36)     | 模板编号 | UUID            |
     | template | varchar(420) | 模板内容 |                 |
     | author   | int(11)      | 作者     | 外联 user 表 id |

* INSTALL

1. 安装依赖包
   #+begin_src sh
# OAuth 验证功能
yum install php-pecl-oauth

# 日志功能
pear channel-discover pear.apache.org/log4php
pear install log4php/Apache_log4php
   #+end_src

gearman
pecl install gearman

brew install php54-redis

2. Web 安装
   - 假如程序包放置在 /www/sms/，sms 目录下应有 htdocs, config,
     include 三个目录；

   - Httpd 配置里把根目录指向 /www/sms/htdocs；

   - 加域名配置为：sms.yukuai.com；

   - 日志文件默认位置在 /var/sms/log/，分收：mo_*.log，发：mt_*.log。

3. 配置短信接收定时任务
   如需收短信，需配置计划任务，任务执行周期建议为 1 分钟，最快周期可设
   置为 5 秒。
   #+BEGIN_EXAMPLE
   crontab -e
   * * * * * curl http://sms.yukuai.com/recive/ 1>/dev/null 2>&1
   #+END_EXAMPLE

4. 测试
   - 发送短信：
     #+BEGIN_EXAMPLE
     curl "http://sms.yukuai.com/send/?m=13896079527&c=回复1注册&u=yue"
     应该返回：141125572066743220

     curl "http://sms.yukuai.com/send/?m=13896079527&c=中奖&u=yue"
     中奖为违禁字,将被拦截.
     应该返回：-64
     #+END_EXAMPLE

** 附一：短信接收工作方式
1. 系统设置计划任务，执行周期为1分钟：curl "http://sms.yukuai.com/recive/"
2. 发送短信时可跟应用来源、用户参数 u, 即 curl "http://sms.yukuai.com/send/?m=13896079527&c=回复1注册&u=yue" ，未设置 u 时，u 的默认值为 test
3. 用户 u 需注册 回调 URL，如 "http://yue.yukuai.com/sms_callback.php"
4. 如果现在，在客户的手机屏幕上，按时间顺序有 4 条短信：
   1. 愉快网 => 用户：欢迎下载优惠劵，回复 1 好评【愉快网】
   2. 愉快网 => 用户：欢迎加入聚餐，回复 1 确定【愉快网】
   3. 用户 => 愉快网：1
   4. 用户 => 愉快网：1
5. 系统每监测到一条用户回复，就会把最近一条发送给用户的短信，和该回复，组成对话，POST 到 回调 URL，即：
   1. POST [短信2，短信3] => "http://yue.yukuai.com/sms_callback.php"
   2. POST [短信2，短信4] => "http://yue.yukuai.com/sms_callback.php"

综上所诉，可以看到这个接口存在的问题是：短信 1 无法取得用户的回复。考虑到这种情况极其少见，所以现在对这个问题未做任何措施。
可选解决方案：
1. 事先定义各种回复，比如回复 21 是好评， 1是注册，以作区分。
2. 接口提供查询API，供各应用自主查询接收短信，自主处理。
